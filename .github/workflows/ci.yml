name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  # Lint and test Portal
  portal:
    name: Portal
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: portal
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: portal/package-lock.json
      
      - name: Install dependencies
        run: npm ci
      
      - name: Type check
        run: npm run type-check
      
      - name: Lint
        run: npm run lint
      
      - name: Build
        run: npm run build

  # Lint and test API Monitor
  api-monitor:
    name: API Monitor
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: api-monitor
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: api-monitor/package-lock.json
      
      - name: Install dependencies
        run: npm ci
      
      - name: Lint
        run: npm run lint
      
      - name: Build
        run: npm run build
      
      - name: Test
        run: npm test
        continue-on-error: true

  # Build Docker images
  docker:
    name: Docker Build
    runs-on: ubuntu-latest
    needs: [portal, api-monitor]
    
    strategy:
      matrix:
        image:
          - name: portal
            context: ./portal
          - name: api-monitor
            context: ./api-monitor
          - name: ccxt
            context: ./docker/ccxt
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Build ${{ matrix.image.name }}
        uses: docker/build-push-action@v5
        with:
          context: ${{ matrix.image.context }}
          push: false
          tags: deluthium/${{ matrix.image.name }}:${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
